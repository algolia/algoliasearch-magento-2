<?php

/** @var \Algolia\AlgoliaSearch\Block\Configuration $block */
/** @var \Magento\Framework\Escaper $escaper */

$configuration = $block->getConfiguration();

// Escape untrusted input (escape inline for PHPCS where possible)
$instantSearchHideCss = $escaper->escapeHtml($configuration['instant']['selector']) . ' {display:none}';

if (class_exists('\Magento\Framework\View\Helper\SecureHtmlRenderer')): ?>
    <?php
    /** @var \Magento\Framework\View\Helper\SecureHtmlRenderer $secureRenderer */
    if ($block->canLoadInstantSearch()) {
        $styleElement = $secureRenderer->renderTag('style', [], $instantSearchHideCss, false);
        /** SecureHtmlRenderer::renderTag yields a false positive on PHPCS */
        echo /** phpcs:ignore Magento2.Security.EscapeOutput.OutputNotEscaped */
            $secureRenderer->renderTag(
                'script',
                [],
                'document.write(\'' . $escaper->escapeJs($styleElement) . '\');',
                false
            );
    }
    ?>

    <?=
    /**
     * SecureHtmlRenderer::renderTag yields a false positive on PHPCS
     * phpcs:ignore Magento2.Security.EscapeOutput.OutputNotEscaped
     */
    $secureRenderer->renderTag(
        'script',
        [],
        "window.algoliaConfig = JSON.parse('" . $escaper->escapeJs(json_encode($configuration)) . "')",
        false
    )
    ?>
<?php else: ?>
    <script>
        <?php
        if ($block->canLoadInstantSearch()):
            $styleElement = "<style>$instantSearchHideCss</style>";
            ?>
        // Hide the instant-search selector ASAP to remove flickering. Will be re-displayed later with JS.
        document.write('<?= $escaper->escapeJs($styleElement) ?>');
            <?php
        endif;
        ?>
        window.algoliaConfig = JSON.parse('<?= $escaper->escapeJs(json_encode($configuration)) ?>');
    </script>
<?php endif; ?>


<?php if ($block->canLoadInstantSearch()): ?>
    <script type="text/x-magento-init">
        {
            "*": {
                "algoliaInstantSearch": {}
            }
        }
    </script>
<?php endif; ?>
